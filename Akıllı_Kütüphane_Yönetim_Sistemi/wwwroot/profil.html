<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Profilim</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <nav class="navbar">
        <div class="logo">
            <img src="logo.png" alt="Logo" width="30" onerror="this.style.display='none'">
            <span>KÃ¼tÃ¼phane</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-item">Ana Sayfa</a></li>
            <li><a href="kitaplar.html" class="nav-item">Kitaplar</a></li>
            <li><a href="rezervasyon.html" class="nav-item">Rezervasyon</a></li>
            <li><a href="odunc.html" class="nav-item">Ã–dÃ¼nÃ§</a></li>
            <li><a href="profil.html" class="nav-item active">Profilim</a></li>
        </ul>
        <div class="logout-section">
            <button onclick="cikisYap()" class="btn-logout">Ã‡Ä±kÄ±ÅŸ Yap ğŸ”´</button>
        </div>
    </nav>

    <div class="container" style="background: transparent; border: none; box-shadow: none;">
        <div class="profil-kutu">
            <h1 style="color: #ff9aa2;">Profil Bilgileri ğŸ‘¤</h1>

            <div class="form-group">
                <label>Ad Soyad:</label>
                <input type="text" id="txtAdSoyad" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z">
            </div>

            <div class="form-group">
                <label>E-Posta (Kimlik):</label>
                <input type="email" id="txtEmail" readonly style="background-color: #eee; cursor: not-allowed;">
                <small style="color:red; font-size:0.8rem;">* E-Posta deÄŸiÅŸtirilemez.</small>
            </div>

            <div class="form-group">
                <label>Yeni Åifre:</label>
                <input type="text" id="txtSifre" placeholder="Yeni ÅŸifreni buraya yaz">
            </div>

            <button onclick="profilGuncelle()" class="btn-pastel btn-pembe">Bilgileri GÃ¼ncelle ğŸ’¾</button>
        </div>
    </div>

    <script>
        // DEÄÄ°ÅÄ°KLÄ°K KONTROLÃœ Ä°Ã‡Ä°N HAFIZA DEÄÄ°ÅKENLERÄ°
        let orijinalAdSoyad = "";
        let orijinalSifre = "";

        document.addEventListener("DOMContentLoaded", function () {
            bilgileriGetir();
        });

        async function bilgileriGetir() {
            const email = localStorage.getItem('email');
            if (!email) {
                window.location.href = "login.html";
                return;
            }

            try {
                const response = await fetch(`/api/kullanici/bilgi/${email}`);
                if (response.ok) {
                    const data = await response.json();

                    // Verileri kutucuklara doldur
                    const tamAd = data.ad + " " + (data.soyad || ""); // Soyad null gelirse boÅŸluk olsun
                    document.getElementById('txtAdSoyad').value = tamAd.trim();
                    document.getElementById('txtEmail').value = data.email;
                    document.getElementById('txtSifre').value = data.sifre;

                    // *** KRÄ°TÄ°K NOKTA: Ä°LK HALÄ°NÄ° HAFIZAYA ALIYORUZ ***
                    orijinalAdSoyad = tamAd.trim();
                    orijinalSifre = data.sifre;
                }
            } catch (error) {
                console.error("Hata:", error);
            }
        }

        async function profilGuncelle() {
            const email = document.getElementById("txtEmail").value;
            const adSoyad = document.getElementById("txtAdSoyad").value.trim(); // BoÅŸluklarÄ± temizle
            const sifre = document.getElementById("txtSifre").value;

            if (adSoyad === "" || sifre === "") {
                alert("Ad Soyad ve Åifre boÅŸ olamaz!");
                return;
            }

            // *** DEÄÄ°ÅÄ°KLÄ°K KONTROLÃœ ***
            // EÄŸer isim aynÄ±ysa VE ÅŸifre aynÄ±ysa -> UyarÄ± ver ve dur.
            if (adSoyad === orijinalAdSoyad && sifre === orijinalSifre) {
                alert("âš ï¸ Herhangi bir deÄŸiÅŸiklik yapmadÄ±nÄ±z!");
                return; // Fonksiyonu burada bitir, sunucuya gitme.
            }

            const veri = {
                email: email,
                adSoyad: adSoyad,
                sifre: sifre
            };

            try {
                const response = await fetch('/api/kullanici/guncelle', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(veri)
                });

                const sonuc = await response.json();
                if (response.ok) {
                    alert("âœ… " + sonuc.mesaj);

                    // BaÅŸarÄ±lÄ± olursa yeni hali artÄ±k orijinal halidir
                    orijinalAdSoyad = adSoyad;
                    orijinalSifre = sifre;

                    // AdÄ± gÃ¼ncelle ki ana sayfada gÃ¶rÃ¼nsÃ¼n
                    localStorage.setItem('ad', adSoyad.split(' ')[0]);
                } else {
                    alert("âŒ Hata: " + sonuc.mesaj);
                }
            } catch (error) {
                alert("Sunucu hatasÄ±!");
            }
        }

        function cikisYap() {
            if (confirm("Ã‡Ä±kÄ±ÅŸ yapmak istiyor musun?")) {
                localStorage.clear();
                window.location.href = "login.html";
            }
        }
    </script>
</body>
</html>