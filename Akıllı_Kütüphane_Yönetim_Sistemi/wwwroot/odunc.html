<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ã–dÃ¼nÃ§ AldÄ±klarÄ±m</title>
    <link rel="stylesheet" href="style.css">
    <script src="log-takip.js"></script>
    <style>
        .sure-var {
            color: #27ae60;
            font-weight: bold;
        }

        .sure-az {
            color: #e67e22;
            font-weight: bold;
        }

        .sure-bitti {
            color: #c0392b;
            font-weight: bold;
        }

        .durum-iade {
            color: #8e44ad;
            font-weight: bold;
            text-decoration: line-through;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">
            <span>ğŸ“š KÃ¼tÃ¼phane</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-item">Ana Sayfa</a></li>
            <li><a href="kitaplar.html" class="nav-item">Kitaplar</a></li>
            <li><a href="rezervasyon.html" class="nav-item">Rezervasyon</a></li>
            <li><a href="odunc.html" class="nav-item active">Ã–dÃ¼nÃ§</a></li>
            <li><a href="profil.html" class="nav-item">Profilim</a></li>
        </ul>
        <div class="logout-section">
            <button onclick="cikisYapVeLogla()" class="btn-logout">Ã‡Ä±kÄ±ÅŸ Yap ğŸ”´</button>
        </div>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin: 0;">Elimdeki Kitaplar ğŸ’</h1>

            <button id="btnArsivle" onclick="gecmisiArsivle()" class="btn-pastel"
                    style="display: none; background-color: #ff9f43; color: white; width: auto; padding: 10px 20px; font-size: 1rem;">
                ğŸ“¦ GeÃ§miÅŸi ArÅŸivle
            </button>
        </div>

        <table class="custom-table">
            <thead>
                <tr id="tabloBaslik">
                </tr>
            </thead>
            <tbody id="oduncListesi">
                <tr><td colspan="7" style="text-align:center;">YÃ¼kleniyor... â³</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            oduncleriGetir();
        });

        function oduncleriGetir() {
            const email = localStorage.getItem('email');
            const isAdmin = localStorage.getItem('isAdmin') === 'true';

            if (!email) {
                window.location.href = "login.html";
                return;
            }

            // --- ADMÄ°N BUTON KONTROLÃœ ---
            if (isAdmin) {
                const btnArsivle = document.getElementById('btnArsivle');
                if (btnArsivle) btnArsivle.style.display = 'block';
            }

            // 1. BAÅLIKLARI AYARLA (Admin ise 'KullanÄ±cÄ±' sÃ¼tunu ekle)
            const baslik = document.getElementById('tabloBaslik');

            let kullaniciBaslik = isAdmin ? `<th>KullanÄ±cÄ±</th>` : ``; // Adminse baÅŸlÄ±k ekle

            let baslikHTML = `
                <th>Kitap AdÄ±</th>
                ${kullaniciBaslik}
                <th>AlÄ±ÅŸ Tarihi</th>
                <th>Son Teslim</th>
                <th>Kalan GÃ¼n</th>
                <th>Ä°ade Durumu</th>
                <th>Teslim Tarihi</th>
                <th>Ceza</th>`;

            baslik.innerHTML = baslikHTML;

            // API'ye isAdmin bilgisini de gÃ¶nderiyoruz
            fetch(`/api/rezervasyon/odunc-listele?email=${email}&isAdmin=${isAdmin}`)
                .then(res => res.json())
                .then(data => {
                    const tablo = document.getElementById('oduncListesi');
                    tablo.innerHTML = "";

                    if (data.length === 0) {
                        let colCount = isAdmin ? 8 : 7;
                        tablo.innerHTML = `<tr><td colspan='${colCount}' style='text-align:center;'>HiÃ§ Ã¶dÃ¼nÃ§ kitap yok.</td></tr>`;
                        return;
                    }

                    data.forEach(item => {
                        let alisTarihi = new Date(item.alisTarihi);
                        let sonTeslim = new Date(item.sonTeslimTarihi);

                        let bugun = new Date();
                        let farkZaman = sonTeslim.setHours(0, 0, 0, 0) - bugun.setHours(0, 0, 0, 0);
                        let kalanGun = Math.ceil(farkZaman / (1000 * 60 * 60 * 24));

                        let durumYazi = "";
                        let stil = "";
                        let butonKodu = "";
                        let teslimTarihiHTML = "";
                        let cezaHTML = "-";

                        // Ceza KontrolÃ¼
                        if (item.paraCezasi && item.paraCezasi > 0) {
                            cezaHTML = `<span style="color:red; font-weight:bold;">${item.paraCezasi} TL</span>`;
                        }

                        // Ä°ade Durumu KontrolÃ¼
                        if (item.teslimTarihi != null) {
                            durumYazi = "Ä°ADE EDÄ°LDÄ° âœ…";
                            stil = "sure-var";
                            butonKodu = "<b>Ä°ÅŸlem Tamam</b>";
                            let tDate = new Date(item.teslimTarihi).toLocaleDateString("tr-TR");
                            teslimTarihiHTML = `<span>${tDate}</span>`;
                        } else {
                            if (kalanGun < 0) {
                                durumYazi = `SÃ¼re Doldu (${Math.abs(kalanGun)} gÃ¼n)`;
                                stil = "sure-bitti";
                            } else if (kalanGun === 0) {
                                durumYazi = "Son GÃ¼n!";
                                stil = "sure-az";
                            } else {
                                durumYazi = `${kalanGun} GÃ¼n KaldÄ±`;
                                stil = "sure-var";
                            }

                            // Sadece Admin Ä°ade Alabilir
                            if (isAdmin) {
                                butonKodu = `<button class="btn-pastel btn-mavi" onclick="iadeAl(${item.islemID})">ğŸ”™ Ä°ade Al</button>`;
                            } else {
                                butonKodu = "<span style='color:#7f8c8d; font-style:italic;'>Teslim Bekleniyor...</span>";
                            }

                            teslimTarihiHTML = `<span style="font-weight:bold; font-size:1.2em; color:#ccc;">-</span>`;
                        }

                        // Admin ise KullanÄ±cÄ± Emailini tabloya yaz
                        let kullaniciVeri = isAdmin ? `<td style="font-size:0.9rem; color:#555;">${item.kullaniciEmail}</td>` : ``;

                        let satir = `<tr>
                            <td>${item.kitapAdi}</td>
                            ${kullaniciVeri}
                            <td>${alisTarihi.toLocaleDateString("tr-TR")}</td>
                            <td>${sonTeslim.toLocaleDateString("tr-TR")}</td>
                            <td class="${stil}">${durumYazi}</td>
                            <td>${butonKodu}</td>
                            <td>${teslimTarihiHTML}</td>
                            <td>${cezaHTML}</td>
                        </tr>`;

                        tablo.innerHTML += satir;
                    });
                })
                .catch(err => console.error("Hata:", err));
        }

        // --- DÄ°ÄER FONKSÄ°YONLAR ---
        function gecmisiArsivle() {
            if (!confirm("âš ï¸ DÄ°KKAT: Ä°ade edilmiÅŸ tÃ¼m kayÄ±tlar arÅŸivlenip bu listeden silinecek. OnaylÄ±yor musunuz?")) return;

            fetch('/api/rezervasyon/odunc-arsivle', { method: 'POST' })
                .then(async res => {
                    const data = await res.json();
                    alert(data.mesaj);
                    window.location.reload();
                })
                .catch(err => {
                    alert("Hata oluÅŸtu: " + err);
                });
        }

        function iadeAl(id) {
            if (!confirm("Bu kitabÄ± iade almak ve varsa cezayÄ± onaylamak istiyor musunuz?")) return;

            fetch(`/api/rezervasyon/iade-et/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(async res => {
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.mesaj || "Hata oluÅŸtu");
                    return data;
                })
                .then(data => {
                    let mesaj = data.mesaj;
                    if (data.ceza > 0) {
                        mesaj += `\nâš ï¸ GECÄ°KME CEZASI: ${data.ceza} TL`;
                    } else {
                        mesaj += "\nâœ… Ceza yok, zamanÄ±nda teslim.";
                    }
                    alert(mesaj);
                    window.location.reload();
                })
                .catch(err => {
                    alert("Ä°ÅŸlem BaÅŸarÄ±sÄ±z: " + err.message);
                });
        }
    </script>
</body>
</html>